flowchart TD
  A[Token usage >= auto_compact_token_limit] --> B{Remote compaction enabled?}
  B -- yes --> C[compact_remote.rs: compact_conversation_history]
  B -- no --> D[compact.rs: summarize + rebuild history]
  C --> E[Replace history + emit ContextCompactedEvent]
  D --> E
