# Context Window and Compaction

This subsystem keeps prompts within token limits and compresses history when
needed.

## Context window management

- Token limits are centralized in `gemini-cli/packages/core/src/core/tokenLimits.ts`.
- `GeminiClient.processTurn` estimates request size and emits
  `ContextWindowWillOverflow` before a request exceeds remaining context.
- Tool output truncation is handled by `ToolExecutor`.

Key files:

- `gemini-cli/packages/core/src/core/tokenLimits.ts`
- `gemini-cli/packages/core/src/core/client.ts`
- `gemini-cli/packages/core/src/scheduler/tool-executor.ts`

## Compaction

- Implemented in `gemini-cli/packages/core/src/services/chatCompressionService.ts`.
- Default trigger: 50% of token limit (`DEFAULT_COMPRESSION_TOKEN_THRESHOLD`).
- Preserve fraction: keep newest 30% of history (`COMPRESSION_PRESERVE_THRESHOLD`).
- Compression prompt is generated by `getCompressionPrompt`.
- Pre-compression hooks fire via `HookSystem`.

Files:

- `gemini-cli/packages/core/src/services/chatCompressionService.ts`
- `gemini-cli/packages/core/src/core/prompts.ts`
- `gemini-cli/packages/core/src/hooks/*`

## Compaction flow

Diagram: `../diagrams/compaction-flow.mmd`.
